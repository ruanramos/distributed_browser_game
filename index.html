<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>Square Game</h1>
    <section>
        <div id="header"></div>
        <br>
    </section>
    <button id="btnCreateGame">New Game</button>
    <select id="selectJoinGame">

    </select>
    <button type="submit" id="btnJoinGame">Join</button>
    <!-- <button id="btnList">List</button> -->

    <script>
        let clientId = null;
        let ws = new WebSocket('ws://localhost:3000');

        // HTML elements
        const btnCreateGame = document.getElementById("btnCreateGame");
        const btnJoinGame = document.getElementById("btnJoinGame");
        const selectJoinGame = document.getElementById("selectJoinGame");
        const header = document.getElementById("header");
        // const btnList = document.getElementById("btnList");

        // Wiring events
        btnCreateGame.addEventListener("click", e => {
            const payload = {
                method: "create",
                clientId: clientId
            };

            ws.send(JSON.stringify(payload));
        });

        btnJoinGame.addEventListener("click", e => {
            const gameId = selectJoinGame.value;

            const payload = {
                method: "join",
                clientId: clientId,
                gameId: gameId
            };

            ws.send(JSON.stringify(payload));
        });

        // btnList.addEventListener("click", e => {
        //     const payload = {
        //         method: "list"
        //     };
        //     ws.send(JSON.stringify(payload));
        // });

        ws.onmessage = (message) => {
            // message.data
            // console.log(message)
            const response = JSON.parse(message.data);
            console.log(response);
            // TODO make this part better, maybe a class extending response
            if (response.method === 'connect') {
                clientId = response.clientId;
                header.append("Client: " + clientId);
                console.log("Client id set successfully " + clientId);
                btnJoinGame.hidden = true;
                if (response.games.length > 0) {
                    btnJoinGame.hidden = false;
                    response.games.forEach(game => {
                        const joinOption = document.createElement('option');
                        joinOption.value = game;
                        joinOption.innerHTML = game;
                        selectJoinGame.appendChild(joinOption);
                    });
                }

            } else if (response.method === 'create') {
                btnJoinGame.hidden = false;
                gameId = response.game.gameId;
                const joinOption = document.createElement('option');
                joinOption.value = gameId;
                joinOption.innerHTML = gameId;
                selectJoinGame.appendChild(joinOption);
                console.log("Game id set successfully " + gameId);
            } else if (response.method === 'join') {
                const selectedGameId = selectJoinGame.value;

                // Check if im already in game
                let lastClient = response.game.clients[response.game.clients.length - 1]
                let isLastClient = lastClient.clientId === clientId;
                if (!isLastClient) {
                    console.log("New client joined game " + response.game.gameId);
                    console.log("Players: " + response.game.clients.length);
                    while (header.firstChild) {
                        header.removeChild(header.firstChild);
                    }
                    header.append("Client: " + clientId);
                    const gameHeader = document.createElement('h2');
                    gameHeader.innerText = `Joined Game: ${response.game.gameId}`;
                    header.appendChild(gameHeader);
                    Object.entries(response.game).forEach(entry => {
                        const div = document.createElement('div');
                        div.id = "game-info";
                        div.innerHTML = `${entry[0]}: ${JSON.stringify(entry[1])}`;
                        header.append(div);
                    })
                    return;
                }
                const color = response.game.clients.filter(client => client.clientId === clientId)[0]['color'];
                const colorDiv = document.createElement('div');
                colorDiv.style.backgroundColor = color;
                colorDiv.style.height = '200px';
                colorDiv.style.width = '200px';
                document.body.append(colorDiv);
                btnJoinGame.hidden = true;
                selectJoinGame.hidden = true;
                btnCreateGame.hidden = true;

                const gameHeader = document.createElement('h2');
                gameHeader.innerText = `Joined Game: ${response.game.gameId}`;
                header.appendChild(gameHeader);

                Object.entries(response.game).forEach(entry => {
                    const div = document.createElement('div');
                    div.innerHTML = `${entry[0]}: ${JSON.stringify(entry[1])}`;
                    header.append(div);
                });
            }

            // else if (response.method === 'list') {
            //     const div = document.createElement('div');
            //     div.innerHTML = `<p>${JSON.stringify(response.games)}</p>`;
            //     document.body.append(div);
            // }

        }
    </script>
</body>

</html>