<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>Square Game</h1>
    <button id="btnCreateGame">New Game</button>
    <select id="selectJoinGame">

    </select>
    <button type="submit" id="btnJoinGame">Join</button>
    <button id="btnList">List</button>

    <script>
        let clientId = null;
        let ws = new WebSocket('ws://localhost:3000');

        // HTML elements
        const btnCreateGame = document.getElementById("btnCreateGame");
        const btnJoinGame = document.getElementById("btnJoinGame");
        const selectJoinGame = document.getElementById("selectJoinGame");
        const btnList = document.getElementById("btnList");

        // Wiring events
        btnCreateGame.addEventListener("click", e => {
            const payload = {
                method: "create",
                clientId: clientId
            };

            ws.send(JSON.stringify(payload));
        });

        btnJoinGame.addEventListener("click", e => {
            const gameId = selectJoinGame.value;

            const payload = {
                method: "join",
                clientId: clientId,
                gameId: gameId
            };

            ws.send(JSON.stringify(payload));
        });

        btnList.addEventListener("click", e => {
            const payload = {
                method: "list"
            };
            ws.send(JSON.stringify(payload));
        });

        ws.onmessage = (message) => {
            // message.data
            // console.log(message)
            const response = JSON.parse(message.data);
            console.log(response);
            // TODO make this part better, maybe a class extending response
            if (response.method === 'connect') {
                clientId = response.clientId;
                document.body.append("Client: " + clientId);
                console.log("Client id set successfully " + clientId);
                console.log(response);
                response.games.forEach(game => {
                    const joinOption = document.createElement('option');
                    joinOption.value = game;
                    joinOption.innerHTML = game;
                    selectJoinGame.appendChild(joinOption);
                });

            } else if (response.method === 'create') {
                gameId = response.game.gameId;
                const joinOption = document.createElement('option');
                joinOption.value = gameId;
                joinOption.innerHTML = gameId;
                selectJoinGame.appendChild(joinOption);
                console.log("Game id set successfully " + gameId);
            } else if (response.method === 'join') {
                const selectedGameId = selectJoinGame.value;
                const color = response.game.clients.filter(client => client.clientId === clientId)[0]['color'];
                const colorDiv = document.createElement('div');
                colorDiv.style.backgroundColor = color;
                colorDiv.style.height = '200px';
                colorDiv.style.width = '200px';
                document.body.append(colorDiv);
                console.log("New client joined game " + response.game.gameId);
                console.log("Players: " + response.game.clients.length);

            } else if (response.method === 'list') {
                const div = document.createElement('div');
                div.innerHTML = `<p>${JSON.stringify(response.games)}</p>`;
                document.body.append(div);
            }

        }
    </script>
</body>

</html>